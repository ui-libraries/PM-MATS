<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Principia LaTeX Renderer</title>
  <!-- Include macros.js -->
  <script type="text/javascript" src="js/macros.js"></script>
  <!-- MathJax Configuration -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        packages: {'[+]': ['base', 'ams']},
        macros: principiaMacros,
      },
      svg: {
        fontCache: 'none',        // Disable font cache
        internalizeFonts: true,   // Embed fonts in SVG
        internalizeStyles: true,  // Embed styles in SVG
      },
    };
  </script>
  <!-- Include MathJax Library -->
  <script type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #latex-input {
      width: 100%;
      height: 150px;
    }
    #output {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
    }
    button {
      margin-right: 10px;
    }
  </style>
</head>
<body>

  <h1>Principia LaTeX Renderer</h1>
  <p>Enter your LaTeX code using Principia macros:</p>
  <textarea id="latex-input">
& \boldsymbol{\pmast2\pmcdot01}. \quad \pmthm \pmdott p \pmimp \pmnot p \pmdot \pmimp \pmdot \pmnot p &
  </textarea>
  <br><br>
  <button onclick="renderLaTeX()">Render</button>
  <button onclick="downloadSVG()">Download SVG</button>

  <div id="output"></div>

  <script>
    function renderLaTeX() {
      let input = document.getElementById('latex-input').value.trim();
      const output = document.getElementById('output');
      output.innerHTML = ''; // Clear previous output

      // Check for ampersands outside of environments
      const hasAmpersand = /&/.test(input);
      const alreadyWrapped = /\\begin{.*}|\\\[|\\\(|\$\$|\$/.test(input);

      if (hasAmpersand && !alreadyWrapped) {
        // Automatically wrap with align* environment
        input = `\\begin{align*}\n${input}\n\\end{align*}`;
      }

      if (typeof MathJax === 'undefined') {
        output.innerHTML = 'MathJax is not loaded.';
        return;
      }

      MathJax.tex2svgPromise(input, { display: true }).then(function (node) {
        output.appendChild(node);
      }).catch(function (err) {
        output.innerHTML = 'Error rendering LaTeX: ' + err.message;
        console.error(err);
      });
    }

    function downloadSVG() {
      const svgElement = document.querySelector('#output svg');
      if (!svgElement) {
        alert('No SVG to download. Please render some LaTeX first.');
        return;
      }

      const serializer = new XMLSerializer();
      let svgString = serializer.serializeToString(svgElement);

      // Add XML declaration
      svgString = '<?xml version="1.0" encoding="UTF-8"?>\n' + svgString;

      const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = 'output.svg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  </script>

</body>
</html>
